using Guna.UI2.WinForms;   // Imports Guna UI2 controls (for modern UI components)
using System;
using System.Data;
using System.Data.SqlClient; // For connecting and querying the SQL database
using System.Drawing;
using System.Linq;
using System.Windows.Forms;
using BCrypt.Net;           // Library for password hashing (BCrypt)

// Namespace of your project
namespace H.E.A.R.Tv2._0
{
    public partial class Form7 : Form
    {
        // Constructor of Form7
        public Form7()
        {
            // Enables smooth graphics rendering to prevent flickering
            this.DoubleBuffered = true;
            this.SetStyle(ControlStyles.OptimizedDoubleBuffer, true);
            this.UpdateStyles();

            // Initializes the form's components
            InitializeComponent();
        }

         //  BUTTON: Back Button
        private void guna2Button2_Click(object sender, EventArgs e)
        {
            // When this button is clicked, open Form2 and close the current form
            Form2 next = new Form2();
            next.Show();
            this.Close();
        }


        //  LABEL: Exit Program
        private void label7_Click(object sender, EventArgs e)
        {
            // Show a confirmation MessageBox before exiting
            var result = MessageBox.Show("Are you want to exit application?", 
                "WARNING", MessageBoxButtons.OKCancel, MessageBoxIcon.Question);

            if (result == DialogResult.OK)
            {
                // If user clicks OK, close the entire application
                Application.Exit();
            }
        }

       
        //  LABEL: Minimize App
        private void label8_Click(object sender, EventArgs e)
        {
            // Minimize all open forms in the application
            foreach (Form f in Application.OpenForms)
            {
                f.WindowState = FormWindowState.Minimized;
            }
        }


        //  BUTTON: Verify Recovery Code (Password Recovery Function)
        private void guna2Button1_Click(object sender, EventArgs e)
        {
            // Get the username and recovery code input by the user
            string username = guna2TextBox2.Text.Trim();
            string recoveryCodeInput = guna2TextBox1.Text.Trim();

            // Validate if both fields are not empty
            if (string.IsNullOrEmpty(username) || string.IsNullOrEmpty(recoveryCodeInput))
            {
                // Show a warning message using Guna2MessageDialog
                Guna2MessageDialog dialog = new Guna2MessageDialog();
                dialog.Caption = "WARNING";
                dialog.Text = "Please enter both username and recovery code.";
                dialog.Style = MessageDialogStyle.Dark;
                dialog.Icon = MessageDialogIcon.Warning;
                dialog.Buttons = MessageDialogButtons.OK;
                dialog.Parent = this; 
                dialog.Show();
                return;
            }

            // Normalize the recovery code (remove spaces, dashes, lowercase it)
            string normalizedInput = recoveryCodeInput.Replace("-", "")
                                                      .Replace(" ", "")
                                                      .Trim()
                                                      .ToLowerInvariant();

            try
            {
                // Connect to local SQL database
                using (SqlConnection conn = new SqlConnection(
                    @"Data Source=(LocalDB)\MSSQLLocalDB;AttachDbFilename=C:\H.E.A.R.Tv2.0\Database\Login.mdf;
                      Integrated Security=True;Connect Timeout=30;Encrypt=True"))
                {
                    conn.Open();

                    // SQL query: Get recovery code of the given username
                    string selectQuery = @"
                    SELECT rc.Recovery_Code
                    FROM RecoveryCodes rc
                    INNER JOIN Users u ON rc.User_Id = u.User_Id
                    WHERE u.Username = @Username";

                    using (SqlCommand cmd = new SqlCommand(selectQuery, conn))
                    {
                        // Add username parameter
                        cmd.Parameters.AddWithValue("@Username", username);

                        using (SqlDataReader reader = cmd.ExecuteReader())
                        {
                            bool found = false; // Flag to check if code is valid

                            // Loop through each recovery code found in DB
                            while (reader.Read())
                            {
                                if (reader.IsDBNull(0))
                                    continue;

                                string storedCode = reader.GetString(0);
                                string normalizedStored = storedCode.Replace("-", "")
                                                                    .Replace(" ", "")
                                                                    .Trim()
                                                                    .ToLowerInvariant();

                                // Compare normalized code from user and DB
                                if (normalizedStored == normalizedInput)
                                {
                                    found = true;
                                    break;
                                }
                            }

                            // If no valid code found, show error message
                            if (!found)
                            {
                                Guna2MessageDialog dialog1 = new Guna2MessageDialog();
                                dialog1.Caption = "Error";
                                dialog1.Text = "Invalid recovery code.";
                                dialog1.Style = MessageDialogStyle.Dark;
                                dialog1.Icon = MessageDialogIcon.Error;
                                dialog1.Buttons = MessageDialogButtons.OK;
                                dialog1.Parent = this;
                                dialog1.Show();
                                return;
                            }
                        }
                    }

                    // If recovery code matched, show success message
                    Guna2MessageDialog successDialog = new Guna2MessageDialog();
                    successDialog.Caption = "Success";
                    successDialog.Text = "Recovery code verified! You can now reset your password.";
                    successDialog.Style = MessageDialogStyle.Dark;
                    successDialog.Icon = MessageDialogIcon.Information;
                    successDialog.Buttons = MessageDialogButtons.OK;
                    successDialog.Parent = this;
                    successDialog.Show();

                    // Optional: Update or mark code as used (if such feature exists)
                    string updateCodeQuery = @"
                    UPDATE rc
                    SET rc.Recovery_Code = rc.Recovery_Code  
                    FROM RecoveryCodes rc
                    INNER JOIN Users u ON rc.User_Id = u.User_Id
                    WHERE u.Username = @Username AND rc.Recovery_Code = @Code";

                    using (SqlCommand cmdUpdate = new SqlCommand(updateCodeQuery, conn))
                    {
                        cmdUpdate.Parameters.AddWithValue("@Username", username);
                        cmdUpdate.Parameters.AddWithValue("@Code", recoveryCodeInput);
                        cmdUpdate.ExecuteNonQuery();
                    }   

                    // Open the password reset form (Form8) with the username
                    Form8 changePasswordForm = new Form8(username);
                    changePasswordForm.Show();

                    // Close the current form
                    this.Close();
                }
            }
            catch (Exception ex)
            {
                // Show any database connection or runtime error
                MessageBox.Show("Error connecting to database: " + ex.Message);
            }
        }

        // Empty event handlers (currently unused)
        private void guna2TextBox1_TextChanged(object sender, EventArgs e) { }
        private void Form7_Load(object sender, EventArgs e) { }
    }
}
