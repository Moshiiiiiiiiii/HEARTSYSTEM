using BCrypt.Net; // (Optional) For password hashing, though not currently used in this code
using Guna.UI2.WinForms; // For Guna2 modern UI controls
using System;
using System.Data.SqlClient; // Used for SQL database connection and commands
using System.Windows.Forms;

namespace H.E.A.R.Tv2._0
{
    public partial class Form8 : Form
    {
        // Stores the username of the account currently resetting the password
        private string currentUsername;

        // Default constructor
        public Form8()
        {
            // Enables double buffering for smoother rendering (less flickering)
            this.DoubleBuffered = true;
            this.SetStyle(ControlStyles.OptimizedDoubleBuffer, true);
            this.UpdateStyles();

            // Initializes all UI components
            InitializeComponent();
        }

        // Overloaded constructor that receives the username from Form7
        public Form8(string username) : this()
        {
            currentUsername = username; // Store the username for later use in SQL update
        }

        private void Form8_Load(object sender, EventArgs e)
        {
            // Executes when the form loads (currently empty)
        }

        // ========================================================
        // ðŸ”˜ BUTTON CLICK: Change Password
        // ========================================================
        private void guna2Button1_Click(object sender, EventArgs e)
        {
            // Get the new password and confirm password from text boxes
            string newPassword = guna2TextBox1.Text.Trim();
            string confirmPassword = guna2TextBox2.Text.Trim();

            // Check if any password field is empty
            if (string.IsNullOrEmpty(newPassword) || string.IsNullOrEmpty(confirmPassword))
            {
                // Show a warning using Guna2 custom message box
                Guna2MessageDialog dialog = new Guna2MessageDialog();
                dialog.Caption = "Warning";
                dialog.Text = "Please fill out both password fields.";
                dialog.Style = MessageDialogStyle.Dark;
                dialog.Icon = MessageDialogIcon.Warning;
                dialog.Buttons = MessageDialogButtons.OK;
                dialog.Parent = this; // Centers relative to your form
                dialog.Show();
                return; // Stop function here
            }

            // (Optional check) You can add: if (newPassword != confirmPassword) { show message }

            try
            {
                // Connect to your local SQL database
                using (SqlConnection conn = new SqlConnection(
                    @"Data Source=(LocalDB)\MSSQLLocalDB;
                      AttachDbFilename=C:\H.E.A.R.Tv2.0\Database\Login.mdf;
                      Integrated Security=True;Connect Timeout=30;Encrypt=True"))
                {
                    conn.Open();

                    // Update the password for the current username
                    string updateUserQuery = "UPDATE Users SET Password = @Password WHERE Username = @Username";

                    using (SqlCommand cmd = new SqlCommand(updateUserQuery, conn))
                    {
                        // Assign parameter values for SQL command
                        cmd.Parameters.AddWithValue("@Password", confirmPassword);
                        cmd.Parameters.AddWithValue("@Username", currentUsername);

                        // Execute the SQL command to update password
                        cmd.ExecuteNonQuery();
                    }

                    // Show success message
                    MessageBox.Show("Password successfully changed!", "Success",
                        MessageBoxButtons.OK, MessageBoxIcon.Information);

                    // Restart the application to refresh state (go back to login)
                    Application.Restart();

                    // Close this form
                    this.Close();
                }
            }
            catch (Exception ex)
            {
                // Show any database connection or SQL error
                MessageBox.Show("Error updating password: " + ex.Message);
            }
        }

        // ================================
        // Empty event handlers for UI elements (unused)
        // ================================
        private void guna2TextBox1_TextChanged(object sender, EventArgs e) { }
        private void guna2TextBox2_TextChanged(object sender, EventArgs e) { }
        private void label1_Click(object sender, EventArgs e) { }
    }
}
